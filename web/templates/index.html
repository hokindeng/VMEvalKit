{% extends "base.html" %}

{% block title %}Dashboard - VMEvalKit{% endblock %}

{% block content %}
<div class="page-header">
    <h1>VMEvalKit Results</h1>
    
    <!-- Project Introduction Box -->
    <div class="project-intro-box">
        <div class="intro-header">
            <h3>üé•üß† VMEvalKit: Video Generation Reasoning Scoring</h3>
        </div>
        <div class="intro-content">
            <p><strong>About:</strong> This dashboard displays results from scoring video generation models on cognitive reasoning tasks including maze solving, chess puzzles, Raven's matrices, 3D rotation, and Sudoku problems.</p>
            
            <p><strong>Dataset:</strong> {{ overview.total_models }} models ¬∑ {{ overview.total_domains }} domains</p>
            
            {% if run_info %}
            <div class="run-info">
                <div class="run-info-grid">
                    <div class="run-info-item">
                        <strong>üöÄ Experiment Run:</strong> {{ run_info.experiment_name }}
                    </div>
                    <div class="run-info-item">
                        <strong>‚è±Ô∏è Completed:</strong> {{ run_info.end_time.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="deployment-info">
                <div class="deployment-links">
                    <div class="deployment-item">
                        <strong>üåê Deployed at:</strong><br>
                        <code>http://192.168.1.73:5000</code>
                    </div>
                    <div class="deployment-item">
                        <strong>üìö Source Code:</strong><br>
                        <a href="https://github.com/hokindeng/VMEvalKit" target="_blank" rel="noopener">https://github.com/hokindeng/VMEvalKit</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    {% if hierarchy %}
    <div class="quick-navigation" style="padding: 12px 14px; background-color: #fcfdff; border: 1px solid #e6ecf2; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.03);">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap;">
            <div style="font-weight: 600;">üìå Quick Navigation (Model ‚Üí Task)</div>
            <div style="font-size: 12px; color: #6b7280;">Jump directly to a model/task</div>
        </div>
        <div class="menu-row" style="margin-top: 10px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
            <label for="modelMenu" style="font-weight: 500; color: #374151;">Model</label>
            <select id="modelMenu" class="nav-select" onchange="onModelChange(this.value)" style="min-width: 180px;">
                <option value="">Select model‚Ä¶</option>
                {% for model in hierarchy %}
                <option value="{{ loop.index }}">ü§ñ {{ model }}</option>
                {% endfor %}
            </select>
            <label for="taskMenu" style="margin-left: 8px; font-weight: 500; color: #374151;">Task</label>
            <select id="taskMenu" class="nav-select" disabled onchange="navigateToModelTask()" style="min-width: 200px;">
                <option value="">Select task‚Ä¶</option>
            </select>
        </div>
        <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
            {% for model in hierarchy %}
            <button onclick="navigateToModel('model-{{ loop.index }}')" class="nav-button" style="padding: 6px 10px; border-radius: 6px;">
                ü§ñ {{ model }}
            </button>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Hierarchical View: Models ‚Üí Domains ‚Üí Tasks -->
{% for model, domains in hierarchy.items() %}
{% set outer_loop = loop %}
<section class="model-section">
    <div class="model-header" onclick="toggleSection('model-{{ loop.index }}')" style="cursor: pointer; background-color: #f0f4f8; padding: 15px; border-radius: 8px; margin-bottom: 10px; transition: background-color 0.3s;">
                <h2>
                    <span class="expand-icon" id="icon-model-{{ loop.index }}">‚ñ∂</span>
            ü§ñ {{ model }}
            <span class="badge">{{ domains.values()|map('length')|sum }} tasks</span>
            <span style="float: right; color: #666; font-size: 14px;">Click to expand</span>
        </h2>
    </div>
    
    <div class="model-content" id="model-{{ loop.index }}" style="display: none">
        {% for domain, tasks in domains.items() %}
        <div class="domain-section">
            <div class="domain-header" onclick="toggleSection('domain-{{ outer_loop.index }}-{{ loop.index }}')" style="cursor: pointer; background-color: #f8f9fa; padding: 10px 15px; border-radius: 6px; margin-bottom: 8px; transition: background-color 0.3s;">
                <h3>
                    <span class="expand-icon" id="icon-domain-{{ outer_loop.index }}-{{ loop.index }}">‚ñ∂</span>
                    {% if domain == 'chess' %}‚ôüÔ∏è{% elif domain == 'maze' %}üåÄ{% elif domain == 'raven' %}üß©{% elif domain == 'rotation' %}üîÑ{% elif domain == 'sudoku' %}üî¢{% else %}üìù{% endif %}
                    {{ domain|title }}
                    <span class="badge">{{ tasks|length }} tasks</span>
                    <span style="float: right; color: #999; font-size: 12px;">Click to toggle</span>
                </h3>
            </div>
            
            <div class="domain-content" id="domain-{{ outer_loop.index }}-{{ loop.index }}" style="display: none">
                <div class="tasks-grid">
                    {% for task in tasks %}
                    <div class="task-card">
                        <!-- Task Header -->
                        <div class="task-header">
                            <span class="task-id">{{ task.task_id }}</span>
                        </div>
                        
                        <!-- Input Image -->
                        {% if task.first_frame %}
                        <div class="task-image-section">
                            <h4>Input Image</h4>
                            <img src="/image/{{ task.first_frame.replace(output_dir, '').lstrip('/') }}" 
                                 alt="Input" class="task-image" loading="lazy">
                        </div>
                        {% endif %}
                        
                        <!-- Prompt -->
                        {% if task.prompt %}
                        <div class="task-prompt-section">
                            <h4>Prompt</h4>
                            <p class="task-prompt">{{ task.prompt }}</p>
                        </div>
                        {% endif %}
                        
                        <!-- Output Video -->
                        {% if task.video_path %}
                        <div class="task-video-section">
                            <h4>Generated Video</h4>
                            <video controls preload="none" class="task-video" muted>
                                <source src="/video/{{ task.video_path.replace(output_dir, '').lstrip('/') }}" type="video/mp4">
                                Your browser does not support video playback.
                            </video>
                        </div>
                        {% endif %}
                        
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endfor %}

{% if not hierarchy %}
<div class="empty-state">
    <div class="empty-icon">üì≠</div>
    <h2>No Results Found</h2>
    <p>Run some experiments first to see results here!</p>
    <pre>python examples/experiment_2025-10-14.py</pre>
</div>
{% endif %}

<script>
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById('icon-' + sectionId);
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        icon.textContent = '‚ñº';
        
        // Load videos when section becomes visible
        const videos = section.querySelectorAll('video[preload="none"]');
        videos.forEach(video => {
            video.preload = 'metadata';
            console.debug(`Upgraded video preloading for: ${video.src || video.querySelector('source')?.src}`);
        });
        
        // Trigger enhanced video loading for newly upgraded videos
        if (videos.length > 0 && window.VMEvalKit?.observeMetadataVideos) {
            setTimeout(() => window.VMEvalKit.observeMetadataVideos(), 100);
        }
    } else {
        section.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}

function navigateToModel(modelId) {
    // First ensure the section is expanded
    const section = document.getElementById(modelId);
    const icon = document.getElementById('icon-' + modelId);
    if (section.style.display === 'none') {
        section.style.display = 'block';
        icon.textContent = '‚ñº';
        
        // Load videos when section becomes visible
        const videos = section.querySelectorAll('video[preload="none"]');
        videos.forEach(video => {
            video.preload = 'metadata';
            console.debug(`Upgraded video preloading for: ${video.src || video.querySelector('source')?.src}`);
        });
        
        // Trigger enhanced video loading for newly upgraded videos
        if (videos.length > 0 && window.VMEvalKit?.observeMetadataVideos) {
            setTimeout(() => window.VMEvalKit.observeMetadataVideos(), 100);
        }
    }
    // Then scroll to it
    setTimeout(function() {
        document.getElementById(modelId).parentElement.scrollIntoView({behavior: 'smooth', block: 'start'});
    }, 100);
}

// Populate the Task menu when a model is selected
function onModelChange(modelIndex) {
    const taskMenu = document.getElementById('taskMenu');
    taskMenu.innerHTML = '<option value="">Select task‚Ä¶</option>';
    taskMenu.disabled = true;

    if (!modelIndex) {
        return;
    }

    const modelSection = document.getElementById('model-' + modelIndex);
    if (!modelSection) {
        return;
    }

    // Ensure the model section is visible to query tasks
    if (modelSection.style.display === 'none') {
        modelSection.style.display = 'block';
        const modelIcon = document.getElementById('icon-model-' + modelIndex);
        if (modelIcon) modelIcon.textContent = '‚ñº';
    }

    // Collect tasks within this model across all domains
    const taskCards = modelSection.querySelectorAll('.task-card .task-id');
    const tasks = Array.from(taskCards).map(el => el.textContent.trim()).filter(Boolean);

    tasks.forEach((taskId) => {
        const opt = document.createElement('option');
        opt.value = taskId;
        opt.textContent = taskId;
        taskMenu.appendChild(opt);
    });

    if (tasks.length > 0) {
        taskMenu.disabled = false;
    }
}

// Navigate to selected model and task
function navigateToModelTask() {
    const modelMenu = document.getElementById('modelMenu');
    const taskMenu = document.getElementById('taskMenu');
    const modelIndex = modelMenu.value;
    const taskId = taskMenu.value;
    if (!modelIndex || !taskId) return;

    // Expand model
    const modelSection = document.getElementById('model-' + modelIndex);
    const modelIcon = document.getElementById('icon-model-' + modelIndex);
    if (modelSection && modelSection.style.display === 'none') {
        modelSection.style.display = 'block';
        if (modelIcon) modelIcon.textContent = '‚ñº';
    }

    // Find the card with the task id
    const target = Array.from(modelSection.querySelectorAll('.task-card .task-id'))
        .find(el => el.textContent.trim() === taskId);
    if (target) {
        // Ensure its domain section is expanded
        const domainContent = target.closest('.domain-content');
        if (domainContent && domainContent.style.display === 'none') {
            domainContent.style.display = 'block';
            const domainId = domainContent.id; // e.g., domain-1-2
            const domainIcon = document.getElementById('icon-' + domainId);
            if (domainIcon) domainIcon.textContent = '‚ñº';
        }

        setTimeout(() => {
            target.closest('.task-card').scrollIntoView({behavior: 'smooth', block: 'center'});
        }, 100);
    }
}

function navigateToTask(taskDomain) {
    // Find the first domain section that matches the task domain
    const allDomainHeaders = document.querySelectorAll('.domain-header h3');
    let targetDomainId = null;
    let targetModelId = null;
    
    for (let header of allDomainHeaders) {
        const domainText = header.textContent.trim().toLowerCase();
        if (domainText.includes(taskDomain.toLowerCase())) {
            // Extract the domain ID from the expand icon
            const expandIcon = header.querySelector('.expand-icon');
            if (expandIcon) {
                const iconId = expandIcon.id; // format: icon-domain-X-Y
                targetDomainId = iconId.replace('icon-', '');
                targetModelId = iconId.match(/icon-domain-(\d+)-/)?.[1];
                break;
            }
        }
    }
    
    if (targetDomainId && targetModelId) {
        // First expand the model section
        const modelSection = document.getElementById('model-' + targetModelId);
        const modelIcon = document.getElementById('icon-model-' + targetModelId);
        if (modelSection && modelSection.style.display === 'none') {
            modelSection.style.display = 'block';
            if (modelIcon) modelIcon.textContent = '‚ñº';
        }
        
        // Then expand the domain section
        const domainSection = document.getElementById(targetDomainId);
        const domainIcon = document.getElementById('icon-' + targetDomainId);
        if (domainSection && domainSection.style.display === 'none') {
            domainSection.style.display = 'block';
            if (domainIcon) domainIcon.textContent = '‚ñº';
        }
        
        // Load videos when sections become visible
        if (modelSection) {
            const videos = modelSection.querySelectorAll('video[preload="none"]');
            videos.forEach(video => {
                video.preload = 'metadata';
            });
        }
        
        // Scroll to the domain section
        setTimeout(function() {
            const targetElement = document.getElementById(targetDomainId);
            if (targetElement) {
                targetElement.parentElement.scrollIntoView({behavior: 'smooth', block: 'start'});
            }
        }, 150);
    }
}

// Add hover effects to clickable headers
document.addEventListener('DOMContentLoaded', function() {
    // Add hover effect to model headers
    document.querySelectorAll('.model-header').forEach(header => {
        header.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e1e8f0';
        });
        header.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#f0f4f8';
        });
    });
    
    // Add hover effect to domain headers
    document.querySelectorAll('.domain-header').forEach(header => {
        header.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#eef0f2';
        });
        header.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#f8f9fa';
        });
    });
});

// Videos are now loaded only when sections expand - no automatic lazy loading needed
</script>

{% endblock %}
